## 实验2 实验报告（Hadoop Streaming + Python）

本实验基于阿里天池 O2O 优惠券数据（2016-01-01 ~ 2016-06-30 训练集）完成四个 MapReduce 任务：商家优惠券使用统计、距离-活跃度统计、优惠券使用间隔统计与排序，以及因素分析（以折扣强度为例）。所有程序采用 Hadoop Streaming + Python 脚本实现，并提供一键脚本 `run.sh` 运行。

---

### 一、设计思路
- 统一预处理
  - 缺失值判断：字符串 `"null"` 或空串均视为缺失；
  - 日期解析：`yyyyMMdd`，用 Python `datetime` 计算领券到使用的天数间隔（负值丢弃）；
  - 距离字段：`NULL` 视为 0，`500` 表示距离大于 10（按题意）。
- 任务1（商家三类行为，线上/线下分开）
  - 判定规则（两表一致）：
    - 负样本（NEG）：Date 为 NULL 且 Coupon_id 非空（领取未使用）
    - 普通消费（NOR/ORD）：Date 非 NULL 且 Coupon_id 为空（未领券直接消费）
    - 正样本（POS）：Date 非 NULL 且 Coupon_id 非空（领取并使用）
  - Map：输出 `(Merchant_id, NEG|NOR|POS)`；Reduce：按商家计数聚合。
- 任务2（线下 距离-活跃用户数）
  - 仅统计“领取并使用”的记录；键为 `(Merchant_id, Distance)`，值为 `User_id`；
  - Reduce 以集合去重统计唯一消费者数（活跃度）。
- 任务3（线下 优惠券使用间隔 Top 券）
  - 阶段1：Map 输出 `(Coupon_id, days)`，Reduce 聚合 `usedCount` 与 `sumDays`；
  - 阶段2：全局统计总使用次数 `totalUsed`，筛选 `usedCount > 1% * totalUsed` 的券，计算 `avgDays = sumDays / usedCount`，按 avgDays 升序输出。
- 任务4（因素分析：折扣强度）
  - 统一折扣为“实际支付比例” `effective = 1 - y/x`（满 x 减 y），或直接折扣比例 `0<x<=1`；
  - 将 `effective` 按两位小数分桶（0.00~1.00），统计每个桶的 `received`、`used`、`usage_rate=used/received`、`avg_interval_days`。

脚本位置：`src/*.py`；一键脚本：`run.sh`（自动拷贝脚本与数据到容器、放入 HDFS、运行并拉取结果）。

---

### 二、运行说明
- 默认容器名为 `h01`，可通过环境变量覆盖：`CONTAINER_NAME=hxx bash 实验二/run.sh all`
- 常用命令：
  - 全部任务：`bash 实验二/run.sh all`
  - 任务1（线下/线上）：`bash 实验二/run.sh task1_offline` / `bash 实验二/run.sh task1_online`
  - 任务2：`bash 实验二/run.sh task2`
  - 任务3（两阶段自动串联）：`bash 实验二/run.sh task3`
  - 任务4（折扣因素分析）：`bash 实验二/run.sh task4`
- 输出目录：`实验二/output/`

---

### 三、运行结果（节选）

- 任务1（线下）：`<Merchant_id>\t<负样本数>\t<普通消费数>\t<正样本数>`

```1:10:/Users/junpingchen/Documents/金融大数据处理技术/FBDP/实验二/output/task1_offline.out
1	0	12	0
100	1	1	0
1000	0	5	0
1001	7	20	14
1002	5	8	0
1003	0	3	0
1004	82	281	1
1005	30	19	1
1007	3	22	0
1008	0	11	0
```

- 任务1（线上）：`<Merchant_id>\t<负样本数>\t<普通消费数>\t<正样本数>`

```1:10:/Users/junpingchen/Documents/金融大数据处理技术/FBDP/实验二/output/task1_online.out
10001	118	792	11
10002	0	30	0
10003	0	110	0
10004	0	35	0
10005	0	26	0
10006	95	43	2
10007	0	495	0
10008	0	265	0
10009	0	109	0
10010	0	10	0
```

- 任务2（线下 商家-距离的活跃用户数）：`<Merchant_id>\t<Distance>\t<UserCount>`

```1:10:/Users/junpingchen/Documents/金融大数据处理技术/FBDP/实验二/output/task2_distance.out
1001	0	3
1001	7	1
1004	0	1
1005	0	1
1010	0	1
1010	1	1
1011	0	5
1011	2	1
1013	4	1
1013	5	1
```

- 任务3（线下 Top 券的平均消费间隔，升序）：`<Coupon_id>\t<平均消费间隔>`

```1:10:/Users/junpingchen/Documents/金融大数据处理技术/FBDP/实验二/output/task3.out
10323	4.96
5686	4.97
12034	8.54
11539	8.65
4773	8.79
2418	9.18
7751	11.22
111	11.24
9776	12.30
```

- 任务4（折扣强度因素分析）：`<bucket>\t<received>\t<used>\t<usage_rate>\t<avg_interval_days>`

```1:15:/Users/junpingchen/Documents/金融大数据处理技术/FBDP/实验二/output/task4_discount.out
0.20	59	3	0.05	0.00
0.33	14	0	0.00	0.00
0.40	3	0	0.00	0.00
0.50	17085	2141	0.13	7.73
0.60	5004	280	0.06	10.05
0.67	7861	247	0.03	8.31
0.70	22886	636	0.03	12.88
0.75	57508	7498	0.13	6.15
0.80	29629	2224	0.08	8.47
0.83	162047	13972	0.09	7.61
0.85	18148	185	0.01	9.19
0.87	10463	144	0.01	12.19
0.90	236845	9379	0.04	9.10
0.93	3230	83	0.03	9.27
0.95	46130	6447	0.14	6.84
```

---

### 四、结果分析与因素影响（任务4）
- 折扣强度与使用率
  - 总体趋势：较大的优惠（较低的支付比例，如 0.50、0.75）对应更高的使用率（约 13%），验证“折扣越大越能促进使用”的直觉；
  - 同时存在非单调现象：如 0.95 桶也表现出较高使用率（14%），可能与满减门槛较低、小额券覆盖面广或活动策略（如强曝光）有关，提示需结合满减门槛/品类/周期做细分分析。
- 折扣强度与使用速度
  - 平均间隔天数在较大优惠时更短（如 0.75 → 6.15 天，0.50 → 7.73 天），表明大额折扣更快触发转化；部分高支付比例（0.95）也有较短间隔（6.84 天），或与“临近有效期提醒/低门槛场景”相关。
- 距离因素与活跃度（结合任务2）
  - 多数商家在 `Distance=0` 的活跃用户数显著高于更远距离（示例：`1011` 在 `0` 距离用户数=5，高于其他距离），印证“距离越近越活跃”的规律；远距离（含 500）总体活跃度较低。
- 线上/线下差异（结合任务1）
  - 线上普通消费（NOR）占比普遍较高，POS 较低；线下部分商家 POS 与 NOR 更均衡，说明线下的到店场景更容易触发券的使用。

结论：折扣强度与距离均对优惠券使用概率与使用时长产生显著影响；但受满减门槛、品类、曝光策略等因素干扰，呈现一定异质性，需在更细粒度维度上联合分析。

---

### 五、可能的改进
- 统计口径与清洗
  - 加入“领券后 15 天内使用”的时间窗筛选，模拟预测任务口径；
  - 区分满减门槛：对 `x:y` 折扣按门槛 `x` 分层，以隔离“门槛效应”；
  - 校正异常日期/距离（负间隔、异常距离）。
- 方法与特征扩展
  - 增加维度：商家品类、用户历史活跃度、发券周期、周末/节假日等；
  - 多因素联合：构建 `effective × distance` 交互分桶，量化叠加效应；
  - 进一步用 Spark 或 Hive 实现，便于大规模多维度聚合。
- 工程与性能
  - 任务1/2可增加 Combiner 以减少 Shuffle；Task3 可使用统一排序器提升全局排序效率；
  - 结果落地改为分区目录（按月份/商家）便于下游消费。

---

### 六、脚本清单
- 运行脚本：`run.sh`
- Map/Reduce 脚本：`src/task1_*.py`、`src/task2_*.py`、`src/task3_*`、`src/task4_*`
- 输出目录：`output/`（本次运行已生成 `task1_offline.out`、`task1_online.out`、`task2_distance.out`、`task3.out`、`task4_discount.out`）

---

如需我把“15 天使用窗”纳入统计或补充更多因素（如门槛/品类/周内节奏）的联合分析，请告诉我，我会在现有脚本基础上追加实现与对比表。 
